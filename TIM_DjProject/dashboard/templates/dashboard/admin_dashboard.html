{% extends "base.html" %}

{% block title %}Staff Dashboard{% endblock %}

{% block content %}
<div class="container fluid px-4" style="padding-top: 0px;">
    <!-- Staff Dashboard Header -->
    <div class="text-center">
        <h2 class="font-weight-bold">Welcome, {{ request.user.first_name|default:request.user.username }}</h2>
        <p class="text-muted">Here you can view all deliveries across all clients.</p>
    </div>
    <!-- Summary Cards -->   
    <div class="row">
        <div class="col-md-3 mb-3">
            <div class="card border-seccess shadow-sm h-80">
                <div class="card-body text-center">
                    <h5 class="text-success">Total Products</h5>
                    <p class="display-4">{{ total_products }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-primary shadow-sm h-80">
                <div class="card-body text-center">
                    <h5 class="text-primary">In Transit</h5>
                    <p class="display-4">{{ in_transit }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-info shadow-sm h-80">
                <div class="card-body text-center">
                    <h5 class="text-info">Delivered</h5>
                    <p class="display-4">{{ delivered }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-danger shadow-sm h-80">
                <div class="card-body text-center">
                    <h5 class="text-danger">Total Vehicles</h5>
                    <p class="display-4">{{ total_vehicles }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid px-4" style="padding-top: 0px;">
    <div class="my-3">
        <label for="productFilter" class="form-label">Filter by Product:</label>
        <select id="productFilter" class="form-select">
            <option value="all">All Products</option>
            {% for product in products %}
                <option value="{{ product.rfid_tag }}">{{ product.name }} ({{ product.rfid_tag }})</option>
            {% endfor %}
        </select>
    </div>
    <!-- Map Container -->
    <div id="map" style="height: 500px; width: 100%; max-width: 100%"></div>
</div>

<!-- Leaflet.js CDN -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>


<script>
var map = L.map('map').setView([28.0339, 1.6596], 5); // Algeria focus

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let markers = {}; // Now an object: { plate_number: marker }
let polylines = {}; // Store path per vehicle
let vehiclePaths = {}; // Store array of coordinates per vehicle

function fetchAndDisplayVehicles(filter = "all") {
    fetch("{% url 'tracking:vehicle_locations' %}")
    .then(response => response.json())
    .then(data => {
        data.vehicles.forEach(vehicle => {
            if (filter === "all" || vehicle.rfid_tag === filter) {
                const latlng = [vehicle.latitude, vehicle.longitude];
                
                if (!markers[vehicle.plate_number]) {
                    // First time seeing this vehicle
                    const marker = L.marker(latlng)
                        .addTo(map)
                        .bindPopup(`<b>${vehicle.vehicle_name}</b><br>Plate: ${vehicle.plate_number}`);
                    
                    markers[vehicle.plate_number] = marker;
                    vehiclePaths[vehicle.plate_number] = [latlng];

                    polylines[vehicle.plate_number] = L.polyline(vehiclePaths[vehicle.plate_number], { color: 'blue' })
                        .addTo(map);
                } else {
                    // Update existing marker position
                    markers[vehicle.plate_number].setLatLng(latlng);

                    // Update path
                    vehiclePaths[vehicle.plate_number].push(latlng);
                    polylines[vehicle.plate_number].setLatLngs(vehiclePaths[vehicle.plate_number]);
                }
            }
        });
    })
    .catch(error => console.error("Error fetching location data:", error));
}

// Initial load
fetchAndDisplayVehicles();

// Auto refresh every 3 seconds
setInterval(() => {
    fetchAndDisplayVehicles();
}, 3000);

// Listen for dropdown change
document.getElementById("productFilter").addEventListener("change", function () {
    const selectedRFID = this.value;

    // Clear all existing markers and paths
    Object.values(markers).forEach(marker => map.removeLayer(marker));
    Object.values(polylines).forEach(polyline => map.removeLayer(polyline));

    markers = {};
    polylines = {};
    vehiclePaths = {};

    fetchAndDisplayVehicles(selectedRFID);
});

</script>


{% endblock %}
