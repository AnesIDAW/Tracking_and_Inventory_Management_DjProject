{% extends "admin/base.html" %}

{% block content %}
<div class="container">
    <h2 class="mt-4">Stuff Dashboard</h2>
    <div class="row">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5>Total Products</h5>
                    <p>{{ total_products }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5>In Transit</h5>
                    <p>{{ in_transit }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5>Delivered</h5>
                    <p>{{ delivered }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5>Total Vehicles</h5>
                    <p>{{ total_vehicles }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div>
    <!-- Map Container -->
    <div id="map" style="height: 500px; width: 430%;"></div>

    <!-- Table Showing Product Status -->
    <table class="table table-striped mt-4">
        <thead>
            <tr>
                <th>Product Name</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for product in client_products %}
            <tr>
                <td>{{ product.name }}</td>
                <td>{{ product.status }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Leaflet.js CDN -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>


<script>
    // Initialize the Map
    var map = L.map('map').setView([0, 0], 2); // Default to world view

    // Load OpenStreetMap Tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Fetch vehicle locations from Django APIs
    fetch("{% url 'dashboard:vehicle_locations' %}")  // âœ… Correct namespaced URL
    .then(response => response.json())
    .then(data => {
        data.vehicles.forEach(vehicle => {
            L.marker([vehicle.latitude, vehicle.longitude])
            .addTo(map)
            .bindPopup(`<b>${vehicle.vehicle_name}</b><br>Plate: ${vehicle.plate_number}`);
        });
    })
    .catch(error => console.error("Error fetching location data:", error));

</script>

{% endblock %}
